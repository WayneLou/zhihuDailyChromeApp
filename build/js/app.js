!function(){"use strict";angular.module("app",["ui.bootstrap","ui.router","ct.ui.router.extras","infinite-scroll","ngAnimate"])}(),function(){"use strict";function e(e,t,n,r){function i(n){t.getTheme(n).then(function(t){e.theme=t,r.theme[n]=t.stories.map(function(e){return e.id}),e.getOldTheme=o(n,t.stories[t.stories.length-1].id)})}function o(n,i){var o=!1,c=!1;return function(){return o||c?!1:(o=!0,void t.getThemeBefore(n,i).then(function(t){return t.stories.length?(t.stories.forEach(function(t){e.theme.stories.push(t),r.theme[n].push(t.id)}),void(i=t.stories[t.stories.length-1].id)):(c=!0,!1)})["finally"](function(){o=!1}))}}e.themeId=n.themeId,i(n.themeId)}e.$inject=["$scope","zhihu","$stateParams","zhihuList"],angular.module("app").controller("themeController",e)}(),function(){"use strict";function e(e,t,n,r){function i(){t.getLatest().then(function(t){e.list=[t],r.main=t.stories.map(function(e){return e.id}),e.getOldNews=o(t.date)})}function o(i){var o=/^(\d{4})(\d{2})(\d{2})$/,c=new Date(i.replace(o,"$1/$2/$3")),u=c.valueOf(),s=!1;return function(){return s?!1:(s=!0,t.getBefore(n("date")(u,"yyyyMMdd")).then(function(t){return t&&t.date?(e.list.push(t),t.stories.forEach(function(e){r.main.push(e.id)}),void(u-=864e5)):!1})["finally"](function(){s=!1}))}}i()}e.$inject=["$scope","zhihu","$filter","zhihuList"],angular.module("app").controller("listController",e)}(),function(){"use strict";function e(e,t,n,r,i,o){function c(){n.getDetail(r.id).then(function(t){e.detail=t}).then(function(){return e.detail.recommenders?n.getRecommenders(r.id):void t.reject()}).then(function(t){e.detail.recommendersDetail=t})}c()}e.$inject=["$scope","$q","zhihu","$stateParams","$state","zhihuList"],angular.module("app").controller("detailController",e)}(),function(){"use strict";angular.module("app").filter("zhihuDate",["$filter",function(e){return function(t,n){if(t){var r=/^(\d{4})(\d{2})(\d{2})$/,i=new Date(t.replace(r,"$1/$2/$3"));return e("date")(i,n)}}}])}(),function(){"use strict";angular.module("app").filter("blob",["zhihu",function(e){function t(t){return e.getBlobUrl(t)}return t.$stateful=!0,t}])}(),function(){"use strict";angular.module("app").directive("zhihuThemes",["zhihu",function(e){function t(t,n,r){e.getThemes().then(function(e){t.themes=e})}var n={restrict:"A",templateUrl:"app/directive/zhihuThemes.html",link:t};return n}])}(),function(){"use strict";angular.module("app").directive("zhihuPage",["$rootScope","zhihu","zhihuList","$state","$stateParams","$filter",function(e,t,n,r,i,o){function c(t,o,c){e.$on("$stateChangeSuccess",function(){if("app.detail"===r.current.name){var e,o;t.themeId=i.themeId,e=i.themeId?n.theme[i.themeId]:n.main,o=e.indexOf(+i.id),-1!==o&&(t.pre=e[o-1],t.next=e[o+1])}else t.pre=t.next=null})}var u={restrict:"EA",templateUrl:"app/directive/page.html",link:c};return u}])}(),function(){"use strict";angular.module("app").directive("chromeBindHtml",["$compile",function(e){function t(t,n,r){t.$watch("chromeBindHtml",function(r){if(r){var i=/<img\s+[^>]*>/gi,o=r.replace(i,function(e){return e.replace(/\ssrc(?=(\s*=))/i," blob-src")}),c=n.html(o);$(c).find("img").each(function(){e(this)(t)}).end().find("a").attr("target","_blank").removeAttr("rel")}})}var n={restrict:"A",scope:{chromeBindHtml:"="},link:t};new DOMParser;return n}])}(),function(){"use strict";angular.module("app").directive("blobSrc",["zhihu",function(e){function t(t,n,r){r.$observe("blobSrc",function(t){t&&e.getBlobUrl(t).then(function(e){r.$set("src",e)})})}var n={restrict:"A",link:t};return n}])}(),function(){"use strict";angular.module("app").directive("backToTop",function(){function e(e,n,r){function i(){t(o)}function o(){u.scrollTop()>u.height()?$(n).fadeIn():$(n).fadeOut()}function c(){u.animate({scrollTop:0},800)}var u=r.backToTop?$(r.backToTop):$(window);u.on("scroll",o),$(n).hide().on("click",c),e.$on("$destroy",function(){u.off("scroll",i)})}function t(e,t){clearTimeout(e.tId),e.tId=setTimeout(function(){e.call(t)},3e3)}var n={restrict:"EA",link:e};return n})}(),function(){"use strict";function e(e,t,n){function r(n){var r=e.defer();return t({method:"GET",url:n,cache:!0,responseType:"blob"}).success(function(e){r.resolve(window.URL.createObjectURL(e))}).error(function(e){r.reject(e)}),r.promise}function i(){var n=e.defer();return t.get("http://news-at.zhihu.com/api/4/news/latest").success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise}function o(n){var r=e.defer();return t.get("http://news.at.zhihu.com/api/4/news/before/"+n,{cache:!0}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise}function c(){var n=e.defer();return t.get("http://news-at.zhihu.com/api/4/themes").success(function(e){n.resolve(e)}).error(function(e){n.reject(e)}),n.promise}function u(n){var r=e.defer();return t.get("http://news-at.zhihu.com/api/4/theme/"+n).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise}function s(n,r){var i=e.defer();return t.get("http://news-at.zhihu.com/api/4/theme/"+n+"/before/"+r,{cache:!0}).success(function(e){i.resolve(e)}).error(function(e){i.reject(e)}),i.promise}function a(n){var r=e.defer();return t.get("http://news-at.zhihu.com/api/4/news/"+n,{cache:!0}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise}function l(n){var r=e.defer();return t.get("http://news-at.zhihu.com/api/4/story/"+n+"/recommenders",{cache:!0}).success(function(e){r.resolve(e)}).error(function(e){r.reject(e)}),r.promise}var h={getBlobUrl:r,getLatest:i,getBefore:o,getThemes:c,getTheme:u,getThemeBefore:s,getDetail:a,getRecommenders:l};return h}e.$inject=["$q","$http","$filter"],angular.module("app").factory("zhihu",e).value("zhihuList",{main:[],theme:{}})}(),function(){"use strict";function e(e,t,n,r,i){i.decorator("$window",["$delegate",function(e){return Object.defineProperty(e,"history",{get:function(){return null}}),e}]),n.otherwise("/"),e.state("app",{"abstract":!0,templateUrl:"app/layout/ui-view.html"}).state("app.list",{url:"/",views:{"list@app":{controller:"listController",templateUrl:"app/layout/list.html"}},sticky:!0,deepStateRedirect:!0}).state("app.detail",{url:"/news/:id/:themeId",views:{"detail@app":{controller:"detailController",templateUrl:"app/layout/detail.html"}}}).state("app.theme",{url:"/theme/:themeId",views:{"theme@app":{controller:"themeController",templateUrl:"app/layout/theme.html"}},sticky:!0,deepStateRedirect:!0}),t.imgSrcSanitizationWhitelist(/^\s*(https?|http|file|tel|blob):/).aHrefSanitizationWhitelist(/^\s*(https?|file|tel|blob|chrome-extension):/),r.resourceUrlWhitelist(["self","http://**"])}function t(e,t,n){e.$state=t,e.$on("$stateChangeSuccess",function(){n.themeId?e.$historyUrl="#/theme/"+n.themeId:e.$historyUrl="#/"})}e.$inject=["$stateProvider","$compileProvider","$urlRouterProvider","$sceDelegateProvider","$provide"],t.$inject=["$rootScope","$state","$stateParams"],angular.module("app").config(e).run(t)}();